<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل قرية ريدة</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .menu-hidden, .hidden {
            display: none;
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #e0f2f1, #b2dfdb, #80cbc4, #4db6ac);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header & Navigation Bar -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-teal-700">دليل قرية ريدة</a>
            <div class="hidden md:flex items-center space-x-6 space-x-reverse">
                <a href="#hero" class="text-gray-700 hover:text-teal-600">الرئيسية</a>
                <a href="#search-section" class="text-gray-700 hover:text-teal-600">بحث بالدليل</a>
                <a href="#education" class="text-gray-700 hover:text-teal-600">التعليم</a>
                <a href="add-service.html" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">أضف نفسك للدليل</a>
            </div>
            <div class="md:hidden">
                <button id="menu-button" class="text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden menu-hidden bg-white">
            <a href="#hero" class="block py-2 px-4 text-sm hover:bg-teal-50">الرئيسية</a>
            <a href="#search-section" class="block py-2 px-4 text-sm hover:bg-teal-50">بحث بالدليل</a>
            <a href="#education" class="block py-2 px-4 text-sm hover:bg-teal-50">التعليم</a>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="hero" class="relative animated-gradient text-white" style="height: 50vh;">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="container mx-auto px-6 h-full flex flex-col justify-center items-center text-center relative z-10">
                <h1 class="text-4xl md:text-6xl font-bold mb-4" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">أهلاً بكم في دليل قرية ريدة</h1>
                <p class="text-lg md:text-xl mb-8 max-w-2xl" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">المكان الذي يجمعنا.. لخدمة مجتمعنا وتسهيل حياتنا اليومية.</p>
                <a href="#search-section" class="bg-white text-teal-700 font-bold py-3 px-8 rounded-full hover:bg-gray-200 shadow-lg transition duration-300">استكشف خدمات القرية</a>
            </div>
        </section>

        <!-- Search Section -->
        <section id="search-section" class="py-16 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">ابحث في دليل القرية</h2>
                    <p class="text-gray-600 mt-2">ابحث بالاسم أو اختر فئة للعثور على ما تريد بسهولة.</p>
                </div>
                <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-4">
                    <input type="text" id="name-search" placeholder="ابحث بالاسم..." class="w-full md:w-1/2 p-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg">
                    <select id="category-filter" class="w-full md:w-1/2 p-4 border bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 text-lg">
                        <option value="all">كل الفئات</option>
                        <optgroup label="خدمات طبية"><option value="طبيب">أطباء</option><option value="صيدلية">صيدليات</option></optgroup>
                        <optgroup label="فنيون وحرفيون (صنايعية)"><option value="كهربائي">كهربائي</option><option value="سباك">سباك</option><option value="نجار">نجار</option><option value="نقاش">نقاش (دهانات)</option><option value="حداد">حداد</option><option value="بنّاء">بنّاء</option><option value="مبلط سيراميك">مبلط سيراميك</option></optgroup>
                        <optgroup label="محلات تجارية"><option value="سوبر ماركت">سوبر ماركت</option><option value="مخبز">مخبز</option><option value="جزار">جزار</option></optgroup>
                        <optgroup label="أخرى"><option value="مدرس">مدرس</option><option value="مهندس">مهندس</option><option value="سائق">سائق</option></optgroup>
                    </select>
                </div>
                
                <div id="loading-indicator" class="text-center py-12">
                    <p class="text-gray-500">جاري تحميل البيانات...</p>
                </div>
                <div id="search-results" class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 hidden"></div>

                <div id="load-more-container" class="text-center mt-12">
                    <button id="load-more-btn" class="bg-gray-700 text-white font-bold py-3 px-10 rounded-lg hover:bg-gray-800 transition hidden">عرض المزيد</button>
                </div>
            </div>
        </section>

        <!-- Education Section -->
        <section id="education" class="py-16 bg-gray-50">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-800">المدارس والتعليم</h2>
                    <p class="text-gray-600 mt-2">معلومات عن مدارس القرية وحلقات تحفيظ القرآن.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                        <img src="images/schools-section.webp" alt="طلاب سعداء أمام مدرسة كرتونية" class="w-full aspect-square object-contain bg-teal-50 p-4">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-xl mb-2">مدارس القرية</h3>
                            <p class="text-gray-700 mb-4 flex-grow">تعرف على مدارسنا، جداول الامتحانات، والنتائج.</p>
                            <a href="schools.html" class="mt-auto text-center bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">الانتقال إلى صفحة المدارس &rarr;</a>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
                        <img src="images/quran-section.webp" alt="مصحف مفتوح يشع منه نور" class="w-full aspect-square object-contain bg-teal-50 p-4">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-xl mb-2">تحفيظ القرآن الكريم</h3>
                            <p class="text-gray-700 mb-4 flex-grow">أدوات تفاعلية للحفظ، أذكار، وأماكن التحفيظ بالقرية.</p>
                            <a href="quran.html" class="mt-auto text-center bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">الانتقال إلى صفحة القرآن &rarr;</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="contact" class="bg-gray-800 text-white pt-12 pb-6">
        <div class="container mx-auto px-6 text-center">
            <p class="text-gray-500">&copy; ٢٠٢٥ - جميع الحقوق محفوظة لدليل قرية ريدة.</p>
        </div>
    </footer>

    <!-- Floating Action Button (Mobile Only) -->
    <a href="add-service.html" class="md:hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-orange-500 text-white font-bold px-6 py-3 rounded-full flex items-center justify-center shadow-lg z-40" aria-label="أضف نفسك للدليل">
        أضف نفسك للدليل
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAD8b7VlestkH5JvIwP0MT566DOu4zGtNI",
            authDomain: "gleaming-bus-468404-u7.firebaseapp.com",
            projectId: "gleaming-bus-468404-u7",
            storageBucket: "gleaming-bus-468404-u7.appspot.com",
            messagingSenderId: "143708510584",
            appId: "1:143708510584:web:46389c2a63a53797e2908d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function authenticateUser() {
            try {
                await signInAnonymously(auth);
                console.log("Authentication successful.");
                listenForServices();
            } catch (error) {
                console.error("Authentication failed:", error);
                document.getElementById('loading-indicator').textContent = 'فشل الاتصال بقاعدة البيانات.';
            }
        }
        authenticateUser();

        const nameSearchInput = document.getElementById('name-search');
        const categoryFilter = document.getElementById('category-filter');
        const resultsContainer = document.getElementById('search-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        let allServicesData = [];
        const ITEMS_PER_PAGE = 6;
        let currentPage = 1;
        let currentFilteredData = [];

        function listenForServices() {
            const servicesCollection = collection(db, "services");
            const q = query(servicesCollection, where("isFeatured", "==", true));

            onSnapshot(q, (querySnapshot) => {
                allServicesData = [];
                querySnapshot.forEach((doc) => {
                    allServicesData.push({ id: doc.id, ...doc.data() });
                });
                loadingIndicator.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                handleSearch(); 
            }, (error) => {
                console.error("Error fetching services: ", error);
                loadingIndicator.textContent = 'حدث خطأ في جلب البيانات.';
            });
        }

        function renderCards(data) {
            resultsContainer.innerHTML = ''; // Clear previous results before rendering new ones
            data.forEach((person) => {
                const uniqueId = `phone-${person.id}`;
                const whatsappLinkNumber = `2${person.whatsappPhone}`;
                
                const imageOrIcon = person.imageUrl
                    ? `<img src="${person.imageUrl}" alt="${person.name}" class="w-24 h-24 rounded-lg mx-auto mb-4 object-contain border-2 border-gray-200 bg-gray-50">`
                    : `<div class="w-24 h-24 bg-teal-100 text-teal-600 rounded-lg flex items-center justify-center mb-4 mx-auto border-2 border-gray-200">
                           <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                       </div>`;

                const card = `
                    <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col text-center transition transform hover:-translate-y-1 hover:shadow-xl">
                        ${imageOrIcon}
                        <h3 class="text-xl font-bold mb-1">${person.name}</h3>
                        <p class="text-gray-500 mb-4">${person.profession}</p>
                        <div class="relative bg-gray-100 rounded-lg p-3 mb-4">
                            <input type="text" readonly id="${uniqueId}" value="${person.phone}" class="w-full bg-transparent text-center font-mono text-lg text-gray-700 outline-none select-all">
                            <button onclick="copyToClipboard('${uniqueId}')" title="نسخ الرقم" class="absolute left-2 top-1/2 -translate-y-1/2 p-1 text-gray-500 hover:text-teal-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div class="flex justify-center space-x-3 space-x-reverse mb-4">
                            <a href="tel:${person.phone}" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition flex items-center justify-center">
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                اتصال
                            </a>
                            <a href="https://wa.me/${whatsappLinkNumber}" target="_blank" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center">
                                <svg class="w-5 h-5 ml-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 9.27 20.92 6.83 19.05 4.96C17.18 3.09 14.74 2 12.04 2ZM12.04 3.62C14.23 3.62 16.23 4.44 17.77 5.97C19.3 7.51 20.13 9.5 20.13 11.91C20.13 16.42 16.52 20 12.04 20C10.58 20 9.19 19.61 7.97 18.89L7.5 18.62L4.32 19.53L5.26 16.43L4.97 15.92C4.18 14.63 3.76 13.13 3.76 11.91C3.76 7.39 7.37 3.62 12.04 3.62ZM9.03 7.23C8.83 7.23 8.66 7.22 8.51 7.51C8.36 7.8 7.88 8.28 7.88 9.38C7.88 10.48 8.54 11.51 8.69 11.69C8.84 11.87 10.06 13.81 12.02 14.59C13.6 15.24 13.99 15.11 14.38 15.07C14.88 15.01 15.81 14.47 16.01 13.87C16.21 13.27 16.21 12.78 16.14 12.67C16.07 12.56 15.92 12.5 15.67 12.38C15.42 12.26 14.28 11.69 14.06 11.6C13.84 11.51 13.69 11.48 13.54 11.77C13.39 12.06 12.92 12.63 12.77 12.8C12.62 12.97 12.47 13 12.22 12.88C11.97 12.76 11.14 12.49 10.12 11.58C9.33 10.88 8.79 10.05 8.67 9.85C8.55 9.65 8.67 9.53 8.77 9.43C8.86 9.33 8.98 9.18 9.11 9.03C9.24 8.88 9.29 8.78 9.36 8.63C9.43 8.48 9.38 8.36 9.33 8.28C9.28 8.2 9.03 7.23 9.03 7.23Z"></path></svg>
                                واتساب
                            </a>
                        </div>
                        ${(person.description || person.address) ? `<div class="text-right border-t pt-4 mt-2 space-y-2">${person.description ? `<p class="text-sm text-gray-700"><strong class="font-bold">وصف:</strong> ${person.description}</p>` : ''}${person.address ? `<p class="text-sm text-gray-700"><strong class="font-bold">العنوان:</strong> ${person.address}</p>` : ''}</div>` : ''}
                    </div>
                `;
                resultsContainer.innerHTML += card;
            });
        }

        function updateResults() {
            const dataToShow = currentFilteredData.slice(0, currentPage * ITEMS_PER_PAGE);
            renderCards(dataToShow);
            loadMoreBtn.classList.toggle('hidden', dataToShow.length >= currentFilteredData.length);
            if (resultsContainer.innerHTML === '') {
                 resultsContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">لا توجد نتائج مطابقة لبحثك.</p>`;
            }
        }

        // *** SEARCH FUNCTION CORRECTED ***
        function handleSearch() {
            const selectedProfession = categoryFilter.value;
            const searchTerm = nameSearchInput.value.trim().toLowerCase();
            currentPage = 1;

            // A single filter pass is cleaner and more reliable
            currentFilteredData = allServicesData.filter(person => {
                const categoryMatch = selectedProfession === 'all' || person.profession === selectedProfession;
                // Ensure person.name exists before calling toLowerCase()
                const nameMatch = !searchTerm || (person.name && person.name.toLowerCase().includes(searchTerm));
                
                return categoryMatch && nameMatch;
            });

            updateResults();
        }

        loadMoreBtn.addEventListener('click', () => {
            currentPage++;
            updateResults();
        });

        categoryFilter.addEventListener('change', handleSearch);
        nameSearchInput.addEventListener('input', handleSearch);

        window.copyToClipboard = function(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
        }
    </script>

</body>
</html>
