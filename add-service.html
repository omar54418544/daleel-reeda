<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة خدمة - دليل قرية ريدة</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Simple Header -->
    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-teal-600">دليل قرية ريدة</a>
            <a href="index.html" class="text-gray-600 hover:text-teal-600 transition duration-300">&larr; العودة للرئيسية</a>
        </nav>
    </header>

    <!-- Form Section -->
    <main class="py-12">
        <div class="container mx-auto px-6">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold">أضف بياناتك إلى دليل القرية</h2>
                    <p class="text-gray-600 mt-2">شارك في إثراء الدليل ببياناتك ليتمكن الجميع من الوصول إليك بسهولة.</p>
                </div>
                <form id="add-person-form">
                    <!-- Form fields... -->
                    <div class="mb-4">
                        <label for="full-name" class="block text-gray-700 font-bold mb-2">الاسم الثلاثي / اسم المحل *</label>
                        <input type="text" id="full-name" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-gray-700 font-bold mb-2">رقم الهاتف *</label>
                        <input type="tel" id="phone" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label for="whatsapp-phone" class="block text-gray-700 font-bold">رقم الواتساب (اختياري)</label>
                            <button type="button" id="same-number-btn" class="text-sm text-teal-600 hover:underline focus:outline-none">نفس رقم الهاتف</button>
                        </div>
                        <input type="tel" id="whatsapp-phone" class="w-full px-3 py-2 border rounded-lg" placeholder="اتركه فارغاً إذا كان نفس رقم الهاتف">
                    </div>
                    <div class="mb-4">
                        <label for="profession" class="block text-gray-700 font-bold mb-2">المهنة / النشاط *</label>
                        <select id="profession" class="w-full px-3 py-2 border bg-white rounded-lg" required>
                             <option value="" disabled selected>-- اختر الفئة --</option>
                            <optgroup label="خدمات طبية">
                                <option value="طبيب">طبيب</option>
                                <option value="صيدلية">صيدلية</option>
                                <option value="ممرض">ممرض</option>
                            </optgroup>
                            <optgroup label="فنيون وحرفيون (صنايعية)">
                                <option value="كهربائي">كهربائي</option>
                                <option value="سباك">سباك</option>
                                <option value="نجار">نجار</option>
                                <option value="نقاش">نقاش (دهانات)</option>
                                <option value="حداد">حداد</option>
                                <option value="بنّاء">بنّاء</option>
                                <option value="مبلط سيراميك">مبلط سيراميك</option>
                                <option value="مبيض محارة">مبيض محارة</option>
                            </optgroup>
                            <optgroup label="محلات تجارية">
                                <option value="سوبر ماركت">سوبر ماركت</option>
                                <option value="مخبز">مخبز</option>
                                <option value="جزار">جزار</option>
                            </optgroup>
                            <optgroup label="شخصيات وخدمات عامة">
                                <option value="شخصية هامة">شخصية هامة</option>
                                <option value="مدرس">مدرس</option>
                                <option value="مهندس">مهندس</option>
                                <option value="سائق">سائق</option>
                                <option value="other_input">مهنة أخرى...</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- New input for other profession -->
                    <div id="other-profession-container" class="mb-4 hidden">
                        <label for="other-profession" class="block text-gray-700 font-bold mb-2">يرجى تحديد المهنة *</label>
                        <input type="text" id="other-profession" class="w-full px-3 py-2 border rounded-lg" placeholder="مثال: خطاط، رسام...">
                    </div>
                    <div class="mb-4">
                        <label for="image-upload" class="block text-gray-700 font-bold mb-2">الصورة الشخصية / صورة المحل (اختياري)</label>
                        <div id="image-upload-box" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <div class="flex text-sm text-gray-600"><label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-teal-600 hover:text-teal-500"><span>اختر ملفًا</span><input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/png, image/jpeg, image/webp"></label></div>
                                <p class="text-xs text-gray-500">PNG, JPG, WEBP</p>
                            </div>
                        </div>
                        <div id="image-preview-container" class="mt-2 text-center hidden">
                             <img id="image-preview" src="" alt="معاينة الصورة" class="max-h-40 mx-auto rounded-lg"/>
                             <button type="button" id="remove-image-btn" class="mt-2 text-sm text-red-600 hover:underline">إزالة الصورة</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="description" class="block text-gray-700 font-bold mb-2">الوصف (اختياري)</label>
                        <textarea id="description" rows="3" class="w-full px-3 py-2 border rounded-lg" placeholder="مثال: مواعيد العمل من ٩ص إلى ٥م، متخصص في..."></textarea>
                    </div>
                    <div id="address-container" class="mb-6 hidden">
                        <label for="address" class="block text-gray-700 font-bold mb-2">العنوان (اختياري)</label>
                        <input type="text" id="address" class="w-full px-3 py-2 border rounded-lg" placeholder="مثال: شارع السوق، بجوار المسجد الكبير">
                    </div>
                    <button type="submit" id="submit-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 flex items-center justify-center">
                        <span id="submit-btn-text">إرسال البيانات للمراجعة</span>
                        <div id="submit-spinner" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <div id="message-toast" class="fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg hidden"></div>

    <!-- Update Info Modal -->
    <div id="update-info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
            <svg class="mx-auto h-16 w-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-2xl font-bold my-4">الرقم مسجل بالفعل!</h2>
            <p class="text-gray-600 mb-6">يبدو أن رقم هاتفك موجود بالفعل في الدليل. إذا كنت ترغب في تحديث بياناتك، يرجى التواصل مع مدير الموقع.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="https://wa.me/201055550195" target="_blank" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 9.27 20.92 6.83 19.05 4.96C17.18 3.09 14.74 2 12.04 2ZM12.04 3.62C14.23 3.62 16.23 4.44 17.77 5.97C19.3 7.51 20.13 9.5 20.13 11.91C20.13 16.42 16.52 20 12.04 20C10.58 20 9.19 19.61 7.97 18.89L7.5 18.62L4.32 19.53L5.26 16.43L4.97 15.92C4.18 14.63 3.76 13.13 3.76 11.91C3.76 7.39 7.37 3.62 12.04 3.62ZM9.03 7.23C8.83 7.23 8.66 7.22 8.51 7.51C8.36 7.8 7.88 8.28 7.88 9.38C7.88 10.48 8.54 11.51 8.69 11.69C8.84 11.87 10.06 13.81 12.02 14.59C13.6 15.24 13.99 15.11 14.38 15.07C14.88 15.01 15.81 14.47 16.01 13.87C16.21 13.27 16.21 12.78 16.14 12.67C16.07 12.56 15.92 12.5 15.67 12.38C15.42 12.26 14.28 11.69 14.06 11.6C13.84 11.51 13.69 11.48 13.54 11.77C13.39 12.06 12.92 12.63 12.77 12.8C12.62 12.97 12.47 13 12.22 12.88C11.97 12.76 11.14 12.49 10.12 11.58C9.33 10.88 8.79 10.05 8.67 9.85C8.55 9.65 8.67 9.53 8.77 9.43C8.86 9.33 8.98 9.18 9.11 9.03C9.24 8.88 9.29 8.78 9.36 8.63C9.43 8.48 9.38 8.36 9.33 8.28C9.28 8.2 9.03 7.23 9.03 7.23Z"></path></svg>
                    واتساب
                </a>
                <a href="https://www.facebook.com/omarr.fathy" target="_blank" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">فيسبوك</a>
            </div>
             <button type="button" id="close-update-modal-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition mt-4">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAD8b7VlestkH5JvIwP0MT566DOu4zGtNI",
            authDomain: "gleaming-bus-468404-u7.firebaseapp.com",
            projectId: "gleaming-bus-468404-u7",
            storageBucket: "gleaming-bus-468404-u7.appspot.com",
            messagingSenderId: "143708510584",
            appId: "1:143708510584:web:46389c2a63a53797e2908d"
        };
        
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = "dmv4i571b";
        const CLOUDINARY_UPLOAD_PRESET = "iiymo4cr";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        signInAnonymously(auth).catch(error => console.error("Anonymous auth failed:", error));

        // --- DOM Elements ---
        const addPersonForm = document.getElementById('add-person-form');
        const professionSelect = document.getElementById('profession');
        const otherProfessionContainer = document.getElementById('other-profession-container');
        const otherProfessionInput = document.getElementById('other-profession');
        const addressContainer = document.getElementById('address-container');
        const imageUploadInput = document.getElementById('image-upload');
        const imageUploadBox = document.getElementById('image-upload-box');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const messageToast = document.getElementById('message-toast');
        const updateInfoModal = document.getElementById('update-info-modal');
        const closeUpdateModalBtn = document.getElementById('close-update-modal-btn');

        let uploadedFile = null;

        // --- Image Upload Logic ---
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imageUploadBox.classList.add('hidden');
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', () => {
            uploadedFile = null;
            imageUploadInput.value = '';
            imagePreviewContainer.classList.add('hidden');
            imageUploadBox.classList.remove('hidden');
        });

        // --- UI Logic ---
        document.getElementById('same-number-btn').addEventListener('click', () => {
            document.getElementById('whatsapp-phone').value = document.getElementById('phone').value;
        });

        const professionsWithAddress = ['طبيب', 'صيدلية', 'سوبر ماركت', 'مخبز', 'جزار'];
        professionSelect.addEventListener('change', (e) => {
            addressContainer.classList.toggle('hidden', !professionsWithAddress.includes(e.target.value));
            
            if (e.target.value === 'other_input') {
                otherProfessionContainer.classList.remove('hidden');
                otherProfessionInput.required = true;
            } else {
                otherProfessionContainer.classList.add('hidden');
                otherProfessionInput.required = false;
            }
        });

        closeUpdateModalBtn.addEventListener('click', () => {
            updateInfoModal.classList.add('hidden');
        });

        // --- Form Submission ---
        addPersonForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            setLoading(true);

            const phoneValue = document.getElementById('phone').value.trim();
            if (!phoneValue) {
                showMessage("يرجى إدخال رقم الهاتف.", 'error');
                setLoading(false);
                return;
            }

            // --- Check for existing phone number ---
            try {
                const servicesRef = collection(db, "services");
                const qServices = query(servicesRef, where("phone", "==", phoneValue));
                const servicesSnapshot = await getDocs(qServices);

                if (!servicesSnapshot.empty) {
                    updateInfoModal.classList.remove('hidden');
                    setLoading(false);
                    return;
                }

                const pendingServicesRef = collection(db, "pending_services");
                const qPending = query(pendingServicesRef, where("phone", "==", phoneValue));
                const pendingSnapshot = await getDocs(qPending);

                if (!pendingSnapshot.empty) {
                    showMessage("هذا الرقم تم إرساله وهو قيد المراجعة حالياً.", 'error');
                    setLoading(false);
                    return;
                }
            } catch (error) {
                console.error("Error checking phone number:", error);
                showMessage("حدث خطأ أثناء التحقق من الرقم. يرجى المحاولة مرة أخرى.", 'error');
                setLoading(false);
                return;
            }
            // --- End check ---


            let professionValue = professionSelect.value;
            if (professionValue === 'other_input') {
                professionValue = otherProfessionInput.value.trim();
                if (!professionValue) {
                    showMessage("يرجى تحديد المهنة الأخرى.", 'error');
                    setLoading(false);
                    return;
                }
            }

            let imageUrl = '';
            if (uploadedFile) {
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                try {
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.secure_url) {
                        imageUrl = data.secure_url;
                    } else { throw new Error('Image upload failed'); }
                } catch (error) {
                    console.error("Error uploading image:", error);
                    showMessage("حدث خطأ أثناء رفع الصورة. يرجى المحاولة مرة أخرى.", 'error');
                    setLoading(false);
                    return;
                }
            }

            try {
                const pendingCollection = collection(db, "pending_services");
                await addDoc(pendingCollection, {
                    name: document.getElementById('full-name').value,
                    phone: phoneValue,
                    whatsappPhone: document.getElementById('whatsapp-phone').value || phoneValue,
                    profession: professionValue,
                    imageUrl: imageUrl,
                    description: document.getElementById('description').value,
                    address: document.getElementById('address').value,
                    createdAt: new Date()
                });
                
                addPersonForm.reset();
                removeImageBtn.click();
                addressContainer.classList.add('hidden');
                otherProfessionContainer.classList.add('hidden');
                
                showMessage('تم إرسال بياناتك للمراجعة بنجاح! سيتم تحويلك الآن للصفحة الرئيسية.', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error("Error writing document: ", error);
                showMessage("حدث خطأ أثناء إرسال البيانات. يرجى المحاولة مرة أخرى.", 'error');
                setLoading(false);
            } 
        });

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            submitBtnText.classList.toggle('hidden', isLoading);
            submitSpinner.classList.toggle('hidden', !isLoading);
        }

        function showMessage(text, type = 'success') {
            messageToast.textContent = text;
            messageToast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg';
            messageToast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            messageToast.classList.remove('hidden');
            
            if (type !== 'success') {
                setTimeout(() => { messageToast.classList.add('hidden'); }, 4000);
            }
        }
    </script>
</body>
</html>
