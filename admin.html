<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - خدمات قرية ريدة اونلاين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .tab-btn.active {
            border-color: #0d9488; /* teal-600 */
            color: #0d9488;
            background-color: #f0fdfa; /* teal-50 */
        }
        .tab-content, .modal { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: slideInUp 0.3s ease-out; }
        @keyframes slideInUp { from { transform: translateY(20px); } to { transform: translateY(0); } }
        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-center">تسجيل دخول المدير</h2>
            <form id="login-form">
                <input type="email" id="email-input" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="البريد الإلكتروني" required>
                <input type="password" id="password-input" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="كلمة المرور" required>
                <button type="submit" id="login-btn" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">دخول</button>
                <p id="error-message" class="text-red-500 text-sm text-center mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <main id="admin-content" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-teal-600">لوحة التحكم</h1>
                <div>
                    <span id="admin-email" class="text-sm text-gray-500 ml-4"></span>
                    <button id="logout-btn" class="text-sm text-red-500 hover:underline">تسجيل الخروج</button>
                </div>
            </div>
            <div class="border-b border-gray-200">
                <nav class="container mx-auto px-6 -mb-px flex space-x-4 space-x-reverse overflow-x-auto" aria-label="Tabs">
                    <button data-tab="doctors" class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm active">إدارة الأطباء</button>
                    <button data-tab="services" class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">إدارة الدليل</button>
                    <button data-tab="events" class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">إدارة المناسبات</button>
                    <button data-tab="bazar" class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">إدارة السوق</button>
                    <!-- ## NEW: Donors Tab ## -->
                    <button data-tab="donors" class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-transparent text-red-500 hover:text-red-700 font-bold">
                        <i class="fas fa-hand-holding-droplet mr-1"></i> إدارة المتبرعين
                    </button>
                </nav>
            </div>
        </header>

        <div class="container mx-auto px-6 py-8">
            <div id="doctors-tab-content" class="tab-content"></div>
            <div id="services-tab-content" class="tab-content hidden"></div>
            <div id="events-tab-content" class="tab-content hidden"></div>
            <div id="bazar-tab-content" class="tab-content hidden"></div>
            <!-- ## NEW: Donors Content Area ## -->
            <div id="donors-tab-content" class="tab-content hidden"></div>
        </div>
    </main>

    <div id="image-viewer-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-4">
        <div class="relative bg-white p-2 rounded-lg max-w-3xl w-full modal-content">
            <button onclick="closeModal('image-viewer-modal')" class="absolute -top-3 -right-3 bg-white rounded-full p-2 text-gray-800 shadow-lg z-10">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
            <img id="modal-image" src="" alt="معاينة الصورة" class="w-full h-auto max-h-[85vh] object-contain rounded">
        </div>
    </div>

    <div id="edit-item-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40 hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">تعديل العنصر</h3>
                    <button onclick="closeModal('edit-item-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <form id="edit-item-form" class="space-y-4">
                    <div id="edit-fields-container" class="space-y-4"></div>
                    <div class="flex justify-end gap-4 pt-4 border-t">
                        <button type="button" onclick="closeModal('edit-item-modal')" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">إلغاء</button>
                        <button type="submit" id="save-changes-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 flex items-center justify-center">
                            <span id="save-btn-text">حفظ التغييرات</span>
                            <div id="save-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, serverTimestamp, getDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAD8b7VlestkH5JvIwP0MT566DOu4zGtNI",
            authDomain: "gleaming-bus-468404-u7.firebaseapp.com",
            projectId: "gleaming-bus-468404-u7",
            storageBucket: "gleaming-bus-468404-u7.appspot.com",
            messagingSenderId: "143708510584",
            appId: "1:143708510584:web:46389c2a63a53797e2908d"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make deleteDonor globally accessible
        window.deleteDonor = async (id) => {
            if (confirm('هل أنت متأكد من حذف هذا المتبرع؟ هذه العملية لا يمكن التراجع عنها.')) {
                try {
                    await deleteDoc(doc(db, "donors", id));
                    alert('تم حذف المتبرع بنجاح.');
                } catch (error) {
                    console.error("Error deleting donor: ", error);
                    alert('حدث خطأ أثناء الحذف.');
                }
            }
        };

        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        window.openImageModal = (imageUrl) => {
            if (!imageUrl || imageUrl.includes('placehold.co')) return;
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('image-viewer-modal').classList.remove('hidden');
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                document.getElementById('admin-email').textContent = user.email;
                initAdminPanel();
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('admin-content').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    const errorMsg = document.getElementById('error-message');
                    errorMsg.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                    errorMsg.classList.remove('hidden');
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        function initAdminPanel() {
            setupTabs();
            loadTabContent('doctors');
        }

        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`${targetTab}-tab-content`).classList.remove('hidden');
                    loadTabContent(targetTab);
                });
            });
        }

        function loadTabContent(tabName) {
            const container = document.getElementById(`${tabName}-tab-content`);
            container.innerHTML = `<div class="text-center py-20"><i class="fas fa-spinner fa-spin text-teal-500 text-4xl"></i><p class="mt-4 text-gray-600">جاري تحميل البيانات...</p></div>`;
            const loaders = {
                doctors: loadDoctorsManagement,
                services: loadServicesManagement,
                events: loadEventsManagement,
                bazar: loadBazarManagement,
                donors: loadDonorsManagement // ## NEW: Add donor loader
            };
            if (loaders[tabName]) {
                loaders[tabName](container);
            }
        }

        const approveItem = async (pendingColl, approvedColl, itemId) => {
            const itemDoc = await getDoc(doc(db, pendingColl, itemId));
            if (itemDoc.exists()) {
                const data = itemDoc.data();
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, approvedColl), data);
                await deleteDoc(doc(db, pendingColl, itemId));
                alert('تمت الموافقة بنجاح!');
            }
        };

        const deleteItem = async (collectionName, itemId) => {
            if (confirm('هل أنت متأكد من رغبتك في الحذف نهائياً؟')) {
                await deleteDoc(doc(db, collectionName, itemId));
                alert('تم الحذف بنجاح.');
            }
        };
        
        const toggleFeature = async (itemId, currentStatus) => {
             await updateDoc(doc(db, "services", itemId), { isFeatured: !currentStatus });
             alert('تم تحديث حالة التمييز بنجاح!');
        };

        const openEditModal = async (collectionName, itemId) => {
            const itemDoc = await getDoc(doc(db, collectionName, itemId));
            if (!itemDoc.exists()) { alert("العنصر غير موجود!"); return; }
            const data = itemDoc.data();
            const fieldsContainer = document.getElementById('edit-fields-container');
            
            const fieldDefinitions = {
                doctors: [
                    { id: 'name', label: 'الاسم', value: data.name },
                    { id: 'specialty', label: 'التخصص', value: data.specialty },
                    { id: 'phones', label: 'الهواتف (افصل بينها بفاصلة)', value: (data.phones || []).join(', ') },
                    { id: 'cities', label: 'المدن (افصل بينها بفاصلة)', value: (data.cities || []).join(', ') },
                    { id: 'addresses', label: 'العناوين (كل فرع في سطر)', value: (data.addresses || []).map(a => `${a.branch}:${a.details}`).join('\n'), type: 'textarea' },
                    { id: 'notes', label: 'ملاحظات', value: data.notes, type: 'textarea' }
                ],
                services: [
                    { id: 'name', label: 'الاسم', value: data.name },
                    { id: 'profession', label: 'المهنة', value: data.profession },
                    { id: 'phone', label: 'الهاتف', value: data.phone },
                    { id: 'whatsappPhone', label: 'واتساب', value: data.whatsappPhone },
                    { id: 'address', label: 'العنوان', value: data.address },
                    { id: 'description', label: 'الوصف', value: data.description, type: 'textarea' }
                ],
                events: [
                    { id: 'title', label: 'العنوان', value: data.title },
                    { id: 'category', label: 'الفئة', value: data.category, type: 'select', options: ['social', 'announcement', 'lostfound'] },
                    { id: 'description', label: 'الوصف', value: data.description, type: 'textarea' },
                    { id: 'contactInfo', label: 'معلومات التواصل', value: data.contactInfo }
                ],
                bazar_items: [
                    { id: 'title', label: 'العنوان', value: data.title },
                    { id: 'price', label: 'السعر', value: data.price, type: 'number' },
                    { id: 'description', label: 'الوصف', value: data.description, type: 'textarea' },
                    { id: 'contactPhone', label: 'هاتف التواصل', value: data.contactPhone }
                ]
            };
            
            const typeKey = collectionName.replace('pending_', '');
            fieldsContainer.innerHTML = fieldDefinitions[typeKey].map(f => {
                if (f.type === 'select') {
                    const optionLabels = { social: 'مناسبة اجتماعية', announcement: 'إعلان هام', lostfound: 'مفقودات' };
                    return `<div><label for="edit-${f.id}" class="block text-sm font-bold text-gray-700 mb-1">${f.label}</label><select id="edit-${f.id}" name="${f.id}" class="w-full px-3 py-2 border bg-white rounded-lg">${f.options.map(o => `<option value="${o}" ${o === f.value ? 'selected' : ''}>${optionLabels[o] || o}</option>`).join('')}</select></div>`;
                }
                return `<div><label for="edit-${f.id}" class="block text-sm font-bold text-gray-700 mb-1">${f.label}</label>${f.type === 'textarea' ? `<textarea id="edit-${f.id}" name="${f.id}" rows="3" class="w-full px-3 py-2 border rounded-lg">${f.value || ''}</textarea>` : `<input type="${f.type || 'text'}" id="edit-${f.id}" name="${f.id}" value="${f.value || ''}" class="w-full px-3 py-2 border rounded-lg">`}</div>`;
            }).join('');

            document.getElementById('edit-item-form').dataset.collection = collectionName;
            document.getElementById('edit-item-form').dataset.id = itemId;
            document.getElementById('edit-item-modal').classList.remove('hidden');
        };
        
        document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { collection: collectionName, id: itemId } = e.target.dataset;
            const formData = new FormData(e.target);
            const updatedData = {};
            
            for (let [key, value] of formData.entries()) {
                if (['phones', 'cities'].includes(key)) {
                    updatedData[key] = value.split(',').map(item => item.trim()).filter(Boolean);
                } else if (key === 'addresses') {
                    updatedData[key] = value.split('\n').map(line => {
                        const [branch, ...details] = line.split(':');
                        return { branch: branch.trim(), details: details.join(':').trim() };
                    }).filter(addr => addr.branch && addr.details);
                } else {
                    updatedData[key] = value;
                }
            }

            try {
                await updateDoc(doc(db, collectionName, itemId), updatedData);
                alert('تم تحديث العنصر بنجاح!');
                closeModal('edit-item-modal');
            } catch (error) {
                console.error("Error updating document: ", error);
                alert('فشل تحديث العنصر.');
            }
        });

        function createManagementUI(container, tabName, titlePending, titleApproved, pendingColl, approvedColl, cardCreator) {
            container.innerHTML = `<h2 class="text-2xl font-bold mb-4">${titlePending} (<span id="${tabName}-pending-count">0</span>)</h2><div id="${tabName}-pending-container" class="space-y-4 mb-12"></div><h2 class="text-2xl font-bold mb-4">${titleApproved} (<span id="${tabName}-approved-count">0</span>)</h2><div id="${tabName}-approved-container" class="space-y-4"></div>`;
            listenForCollection(pendingColl, `${tabName}-pending-container`, `${tabName}-pending-count`, cardCreator);
            listenForCollection(approvedColl, `${tabName}-approved-container`, `${tabName}-approved-count`, cardCreator);
        }

        const loadDoctorsManagement = (c) => createManagementUI(c, 'doctors', 'طلبات إضافة أطباء', 'دليل الأطباء العام', 'pending_doctors', 'doctors', createDoctorCard);
        const loadServicesManagement = (c) => createManagementUI(c, 'services', 'طلبات إضافة للدليل', 'الدليل العام', 'pending_services', 'services', createServiceCard);
        const loadEventsManagement = (c) => createManagementUI(c, 'events', 'طلبات نشر إعلانات', 'الإعلانات المنشورة', 'pending_events', 'events', createEventCard);
        const loadBazarManagement = (c) => createManagementUI(c, 'bazar', 'إعلانات سوق قيد المراجعة', 'إعلانات السوق المنشورة', 'pending_bazar_items', 'bazar_items', createBazarCard);

        function listenForCollection(collectionName, containerId, countId, cardCreator) {
            onSnapshot(collection(db, collectionName), (snapshot) => {
                const container = document.getElementById(containerId);
                const countSpan = document.getElementById(countId);
                if (!container || !countSpan) return;

                container.innerHTML = '';
                countSpan.textContent = snapshot.size;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">لا توجد عناصر لعرضها.</p>';
                    return;
                }
                snapshot.docs.sort((a,b) => (b.data().createdAt?.toDate() || 0) - (a.data().createdAt?.toDate() || 0)).forEach(doc => {
                    container.appendChild(cardCreator({ id: doc.id, ...doc.data() }, collectionName));
                });
            });
        }

        function createCard(data, contentHtml, actions) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-md flex items-start sm:items-center justify-between flex-col sm:flex-row gap-4';
            div.innerHTML = `<div class="flex items-center gap-4 flex-grow min-w-[200px]">${data.imageUrl ? `<button onclick="openImageModal('${data.imageUrl}')" class="focus:outline-none flex-shrink-0"><img src="${data.imageUrl}" alt="صورة مصغرة" class="w-16 h-16 rounded-lg object-cover bg-gray-200 hover:opacity-80 transition-opacity"></button>`: ''}<div class="flex-grow">${contentHtml}</div></div><div class="flex gap-2 flex-shrink-0 self-end sm:self-center">${actions.join('')}</div>`;
            return div;
        }

        function createDoctorCard(data, collectionName) {
            const isPending = collectionName.startsWith('pending');
            const content = `<p class="font-bold text-lg">${data.name} <span class="text-base font-normal text-teal-600">(${data.specialty})</span></p><p class="text-sm text-gray-600">${(data.phones || []).join(' - ')}</p>`;
            const actions = [
                isPending ? `<button data-action="approve" data-id="${data.id}" data-type="doctor" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">موافقة</button>` : '',
                `<button data-action="edit" data-id="${data.id}" data-collection="${collectionName}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">تعديل</button>`,
                `<button data-action="delete" data-id="${data.id}" data-collection="${collectionName}" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">حذف</button>`
            ];
            return createCard(data, content, actions.filter(Boolean));
        }
        
        function createServiceCard(data, collectionName) {
            const isPending = collectionName.startsWith('pending');
            const content = `<p class="font-bold">${data.name} (${data.profession})</p><p class="text-sm text-gray-600">${data.phone}</p>`;
            const actions = [
                isPending ? `<button data-action="approve" data-id="${data.id}" data-type="service" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">موافقة</button>` : '',
                !isPending ? `<button data-action="feature" data-id="${data.id}" data-featured="${data.isFeatured || false}" class="${data.isFeatured ? 'bg-yellow-500' : 'bg-gray-400'} text-white px-3 py-1 rounded text-sm">${data.isFeatured ? 'مميز' : 'تمييز'}</button>` : '',
                `<button data-action="edit" data-id="${data.id}" data-collection="${collectionName}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">تعديل</button>`,
                `<button data-action="delete" data-id="${data.id}" data-collection="${collectionName}" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">حذف</button>`
            ];
            return createCard(data, content, actions.filter(Boolean));
        }
        
        function createEventCard(data, collectionName) {
            const isPending = collectionName.startsWith('pending');
            const content = `<p class="font-bold">${data.title}</p><p class="text-sm text-gray-600">${data.category}</p>`;
            const actions = [
                isPending ? `<button data-action="approve" data-id="${data.id}" data-type="event" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">موافقة</button>` : '',
                `<button data-action="edit" data-id="${data.id}" data-collection="${collectionName}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">تعديل</button>`,
                `<button data-action="delete" data-id="${data.id}" data-collection="${collectionName}" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">حذف</button>`
            ];
            return createCard(data, content, actions.filter(Boolean));
        }

        function createBazarCard(data, collectionName) {
            const isPending = collectionName.startsWith('pending');
            const content = `<p class="font-bold">${data.title}</p><p class="text-sm text-teal-600 font-semibold">${data.price} جنيه</p>`;
            const actions = [
                isPending ? `<button data-action="approve" data-id="${data.id}" data-type="bazar" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">موافقة</button>` : '',
                `<button data-action="edit" data-id="${data.id}" data-collection="${collectionName}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">تعديل</button>`,
                `<button data-action="delete" data-id="${data.id}" data-collection="${collectionName}" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">حذف</button>`
            ];
            return createCard(data, content, actions.filter(Boolean));
        }
        
        // ## NEW: Function to load and manage blood donors ##
        function loadDonorsManagement(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold">قائمة المتبرعين بالدم (<span id="donors-count">0</span>)</h2>
                     <div class="flex items-center gap-2">
                        <label for="blood-type-filter" class="font-bold text-sm">فلترة حسب الفصيلة:</label>
                        <select id="blood-type-filter" class="p-2 border bg-white rounded-lg shadow-sm">
                            <option value="all">كل الفصائل</option>
                            <option value="A+">A+</option> <option value="A-">A-</option>
                            <option value="B+">B+</option> <option value="B-">B-</option>
                            <option value="O+">O+</option> <option value="O-">O-</option>
                            <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
                    <table class="min-w-full w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-right font-bold">الاسم</th>
                                <th class="p-4 text-right font-bold">فصيلة الدم</th>
                                <th class="p-4 text-right font-bold">رقم الهاتف</th>
                                <th class="p-4 text-right font-bold">آخر تبرع</th>
                                <th class="p-4 text-right font-bold">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="donors-table-body">
                            <!-- Rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            `;

            const tableBody = document.getElementById('donors-table-body');
            const filterSelect = document.getElementById('blood-type-filter');
            const donorsCountSpan = document.getElementById('donors-count');
            let allDonors = []; 

            const donorsQuery = query(collection(db, "donors"), orderBy("createdAt", "desc"));
            onSnapshot(donorsQuery, (snapshot) => {
                allDonors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                donorsCountSpan.textContent = allDonors.length;
                renderTable(allDonors);
                filterSelect.dispatchEvent(new Event('change')); // Apply filter after data load
            });

            filterSelect.addEventListener('change', () => {
                const selectedType = filterSelect.value;
                if (selectedType === 'all') {
                    renderTable(allDonors);
                } else {
                    const filteredDonors = allDonors.filter(donor => donor.bloodType === selectedType);
                    renderTable(filteredDonors);
                }
            });

            function renderTable(donors) {
                tableBody.innerHTML = '';
                if (donors.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">لا توجد نتائج مطابقة للبحث.</td></tr>';
                    return;
                }
                donors.forEach(donor => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    const lastDonation = donor.lastDonationDate 
                        ? donor.lastDonationDate.toDate().toLocaleDateString('ar-EG')
                        : '<span class="text-gray-400">غير محدد</span>';

                    row.innerHTML = `
                        <td class="p-4 font-semibold">${donor.name}</td>
                        <td class="p-4 text-red-600 font-mono text-xl font-bold">${donor.bloodType}</td>
                        <td class="p-4 font-mono text-lg" dir="ltr">${donor.phone}</td>
                        <td class="p-4 text-sm text-gray-600">${lastDonation}</td>
                        <td class="p-4">
                            <a href="tel:${donor.phone}" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">اتصال</a>
                            <button onclick="deleteDonor('${donor.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 mr-2">حذف</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }


        document.getElementById('admin-content').addEventListener('click', (e) => {
            const target = e.target.closest('button, a'); // Listen for buttons and links
            if (!target) return;

            const { action, id, type, collection, featured } = target.dataset;
            
            if (!action) return; // Exit if no data-action attribute

            const collectionsMap = {
                doctor: { pending: 'pending_doctors', approved: 'doctors' },
                service: { pending: 'pending_services', approved: 'services' },
                event: { pending: 'pending_events', approved: 'events' },
                bazar: { pending: 'pending_bazar_items', approved: 'bazar_items' }
            };

            if (action === 'approve') {
                const { pending, approved } = collectionsMap[type];
                approveItem(pending, approved, id);
            } else if (action === 'delete') {
                deleteItem(collection, id);
            } else if (action === 'feature') {
                toggleFeature(id, featured === 'true');
            } else if (action === 'edit') {
                openEditModal(collection, id);
            } else if (action === 'view-image') {
                openImageModal(target.dataset.url);
            }
        });

    </script>
</body>
</html>
